/*!
jQuery smallipop plugin
@name jquery.smallipop.js
@author Sebastian Helzle (sebastian@helzle.net or @sebobo)
@version 0.5.1
@date 2013-03-10
@category jQuery plugin
@copyright (c) 2011-2013 Small Improvements (http://www.small-improvements.com)
@license Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php) license.
*/
(function(e){var t;return e.smallipop=t={version:"0.5.1",defaults:{autoscrollPadding:200,contentAnimationSpeed:150,cssAnimations:{enabled:!1,show:"animated fadeIn",hide:"animated fadeOut"},funcEase:"easeInOutQuad",handleInputs:!0,hideDelay:500,hideTrigger:!1,hideOnPopupClick:!0,hideOnTriggerClick:!0,infoClass:"smallipopHint",invertAnimation:!1,popupOffset:31,popupYOffset:0,popupDistance:20,popupDelay:100,popupAnimationSpeed:200,preferredPosition:"top",referencedSelector:null,theme:"default",touchSupport:!0,tourHighlight:!1,tourHighlightColor:"#222",tourHightlightFadeDuration:200,tourHighlightOpacity:.5,tourHighlightZIndex:9997,triggerAnimationSpeed:150,triggerOnClick:!1,onAfterHide:null,onAfterShow:null,onBeforeHide:null,onBeforeShow:null,onTourClose:null,onTourNext:null,onTourPrev:null,windowPadding:30},currentTour:null,lastId:1,nextInstanceId:1,lastScrollCheck:0,labels:{prev:"Prev",next:"Next",close:"Close",of:"of"},instances:{},scrollTimer:null,refreshQueueTimer:null,templates:{popup:'<div class="smallipop-instance"><div class="sipContent"/><div class="sipArrowBorder"/><div class="sipArrow"/></div>'},tours:{},_hideSmallipop:function(o){var i,n,r,a,s,l,p,u,d,c,h,f,g,m,v,T,_;clearTimeout(t.scrollTimer),u=(null!=o?o.target:void 0)?e(o.target):o,m=t.instances,_=[];for(l in m)a=m[l],s=a.data(),(p=s.shown)&&(!s.isTour||a.is(u))&&(d=e(".smallipop"+p),c=(null!=(v=d.data("smallipop"))?v.options:void 0)||t.defaults,s.isTour&&(t.currentTour=null,null!=(T=d.data("smallipop"))&&"function"==typeof(g=T.options).onTourClose&&g.onTourClose(),this._hideTourOverlay(c)),r=!c.hideOnTriggerClick&&u.is(d),n=!c.hideOnPopupClick&&a.find(u).length,u&&d.length&&"click"===(null!=o?o.type:void 0)&&(r||n)||(p&&c.hideTrigger&&d.stop(!0).fadeTo(c.triggerAnimationSpeed,1),a.data({hideDelayTimer:null,beingShown:!1}),c.cssAnimations.enabled?(a.removeClass(c.cssAnimations.show).addClass(c.cssAnimations.hide).data("shown",""),c.onAfterHide?_.push(window.setTimeout(c.onAfterHide,c.popupAnimationSpeed)):_.push(void 0)):(i=c.invertAnimation?-1:1,h=s.xDistance*i,f=s.yDistance*i,_.push(a.stop(!0).animate({top:"-="+f+"px",left:"+="+h+"px",opacity:0},c.popupAnimationSpeed,c.funcEase,function(){var t;return t=e(this),t.data("beingShown")||t.css("display","none").data("shown",""),"function"==typeof c.onAfterHide?c.onAfterHide():void 0})))));return _},_showSmallipop:function(o){var i,n;return i=e(this).data("smallipop"),i.popupInstance.data("shown")===i.id||"checkbox"!==(n=!i.type)&&"radio"!==n||null!=o&&o.preventDefault(),t._triggerMouseover.call(this)},_onTouchDevice:function(){return"undefined"!=typeof Modernizr&&null!==Modernizr?Modernizr.touch:void 0},_killTimers:function(e){return clearTimeout(e.data("hideDelayTimer")),clearTimeout(e.data("showDelayTimer"))},_queueRefreshPosition:function(e){return null==e&&(e=50),clearTimeout(t.refreshQueueTimer),t.refreshQueueTimer=setTimeout(t._refreshPosition,e)},_refreshPosition:function(o){var i,n,r,a,s,l,p,u,d,c,h,f,g,m,v,T,_,w,y,I,x,C,S,b,P,A,k,H,O,D,M,z,N,Z,F,B,L,W;null==o&&(o=!0),L=t.instances,W=[];for(g in L)s=L[g],p=s.data(),C=p.shown,C&&(S=e(".smallipop"+C),b=S.data("smallipop"),a=b.options,s.removeClass(function(e,t){return((null!=t?t.match(/sip\w+/g):void 0)||[]).join(" ")}),o&&s.attr("class","smallipop-instance "+a.theme),P=e(window),M=Z=a.popupDistance,z=a.popupOffset,F=a.popupYOffset,i="fixed"===s.data("position"),f=s.outerHeight(),T=s.outerWidth(),l=T/2,O=P.width(),A=P.height(),H=P.scrollTop(),k=P.scrollLeft(),D=a.windowPadding,n=S.offset(),I=S.outerWidth(),y=S.outerHeight(),x=n.top-H,m=n.left+I/2,v=n.top-f+F,_=f+a.popupDistance-F,h=x-_,u=A-x-y-_,d=n.left-T-z,c=O-n.left-I-T,w=a.preferredPosition,"left"===w||"right"===w?(Z=0,v+=y/2+f/2,"right"===w&&c>D||D>d?(s.addClass("sipPositionedRight"),m=n.left+I+z):(s.addClass("sipPositionedLeft"),m=n.left-T-z,M=-M)):(M=0,m+l>O-D?(m-=2*l-z,s.addClass("sipAlignLeft")):D>m-l?(m-=z,s.addClass("sipAlignRight")):m-=l,D>m&&(m=D),("bottom"===w&&u>D||D>h)&&(Z=-Z,v+=f+y-2*F,s.addClass("sipAlignBottom"))),y>f&&(B=v+f+D-Z+F-H-A,B>0&&(v=Math.max(v-B-D,n.top+F+D+Z))),I>T&&(N=m+T+D+M+z-k-O,N>0&&(m=Math.max(m-N+D,n.left+z+D-M))),a.hideTrigger&&S.stop(!0).fadeTo(a.triggerAnimationSpeed,0),r=0,(!p.beingShown||a.cssAnimations.enabled)&&(v-=Z,m+=M,M=0,Z=0,r=1),i&&(m-=k,v-=H),s.data({xDistance:M,yDistance:Z}).css({top:v,left:m,display:"block",opacity:r}),W.push(t._fadeInPopup(s,{top:"-="+Z+"px",left:"+="+M+"px",opacity:1})));return W},_fadeInPopup:function(e,o){var i,n;return i=(null!=(n=t._getTrigger(e.data("shown")).data("smallipop"))?n.options:void 0)||t.defaults,i.cssAnimations.enabled?(e.addClass(i.cssAnimations.show),window.setTimeout(function(){return t._fadeInPopupFinished(e,i)},i.popupAnimationSpeed)):e.stop(!0).animate(o,i.popupAnimationSpeed,i.funcEase,function(){return t._fadeInPopupFinished(e,i)})},_fadeInPopupFinished:function(e,o){var i;return i=e.data(),i.beingShown?(e.data("beingShown",!1),"function"==typeof o.onAfterShow?o.onAfterShow(t._getTrigger(i.shown)):void 0):void 0},_getTrigger:function(t){return e(".smallipop"+t)},_showPopup:function(o,i){var n,r,a,s,l,p,u,d,c;return null==i&&(i=""),d=o.data("smallipop"),c=d.options,a=d.popupInstance,a.data("triggerHovered")?(p=a.data("shown"),p&&(n=t._getTrigger(p),n.length&&(r=n.data("smallipop").options||t.defaults,r.hideTrigger&&n.stop(!0).fadeTo(r.fadeSpeed,1))),c.tourHighlight&&c.tourIndex?(u=this._getTourOverlay(c),this._resetTourZIndices(),"static"===o.css("position")&&o.css("position","relative"),o.data("originalZIndex")||o.data("originalZIndex",o.css("zIndex")),o.css("zIndex",c.tourHighlightZIndex+1),u.fadeTo(c.tourHightlightFadeDuration,c.tourHighlightOpacity)):this._hideTourOverlay(c),s=i||d.hint,c.referencedContent&&!i&&(s=e(c.referencedContent).clone(!0,!0)||s),l=this._isElementFixed(o)?"fixed":"absolute",p!==d.id&&a.hide(0),a.data({beingShown:!0,shown:d.id,position:l}).find(".sipContent").empty().append(s),a.css("position",l),t._queueRefreshPosition(0)):void 0},_isElementFixed:function(e){var t;for(t=e;t.length&&"HTML"!==t[0].nodeName;){if("fixed"===t.css("position"))return!0;t=t.parent()}return!1},_triggerMouseover:function(){var o,i,n,r,a,s;return r=i=e(this),o=r.hasClass("sipInitialized"),o||(r=t._getTrigger(i.data("shown"))),r.length?(a=r.data("smallipop"),i=a.popupInstance.data(o?"triggerHovered":"hovered",!0),t._killTimers(i),n=i.data("shown"),n!==a.id||0===i.css("opacity")?("function"==typeof(s=a.options).onBeforeShow&&s.onBeforeShow(r),i.data("showDelayTimer",setTimeout(function(){return t._showPopup(r)},a.options.popupDelay))):void 0):void 0},_triggerMouseout:function(){var o,i,n,r,a,s;return r=i=e(this),o=r.hasClass("sipInitialized"),o||(r=t._getTrigger(i.data("shown"))),r.length?(a=r.data("smallipop"),i=a.popupInstance.data(o?"triggerHovered":"hovered",!1),t._killTimers(i),n=i.data(),n.hovered||n.triggerHovered?void 0:("function"==typeof(s=a.options).onBeforeHide&&s.onBeforeHide(r),i.data("hideDelayTimer",setTimeout(function(){return t._hideSmallipop(i)},a.options.hideDelay)))):void 0},_onWindowScroll:function(){return clearTimeout(t.scrollTimer),t.scrollTimer=setTimeout(function(){return t._refreshPosition(!1)},250)},setContent:function(o,i){var n,r,a;if(null!=o?o.length:void 0)return a=o.data("smallipop"),n=a.tourTitle,r=n?a.popupInstance.find(".smallipop-tour-content"):a.popupInstance.find(".sipContent"),r.html()!==i?r.stop(!0).fadeTo(a.options.contentAnimationSpeed,0,function(){return e(this).html(i).fadeTo(a.options.contentAnimationSpeed,1),t._refreshPosition()}):void 0},_runTour:function(e,o){var i,n,r,a,s,l;if(a=e.data("smallipop"),r=null!=a?a.tourTitle:void 0,r&&t.tours[r])for(t.tours[r].sort(function(e,t){return e.index-t.index}),"number"!=typeof o||0!==o%1?o=0:o-=1,t.currentTour=r,i=t.tours[r],n=s=0,l=i.length-1;l>=0?l>=s:s>=l;n=l>=0?++s:--s)if(n===o||i[n].id===a.id)return t._tourShow(r,n)},_tourShow:function(o,i){var n,r,a,s,l,p,u,d;return(s=t.tours[o])?(u=s[i].trigger,d=u.data("smallipop"),p=i>0?'<a href="#" class="smallipop-tour-prev">'+t.labels.prev+"</a>":"",l=s.length-1>i?'<a href="#" class="smallipop-tour-next">'+t.labels.next+"</a>":"",r=i===s.length-1?'<a href="#" class="smallipop-tour-close">'+t.labels.close+"</a>":"",a='<a href="#" class="smallipop-tour-close-icon">&Chi;</a>',n=e(e.trim('        <div class="smallipop-tour-content"></div>        '+a+'        <div class="smallipop-tour-footer">          <div class="smallipop-tour-progress">            '+(i+1)+" "+t.labels.of+" "+s.length+"          </div>          "+p+"          "+l+"          "+r+"        </div>")),n.eq(0).append(d.hint),t._killTimers(d.popupInstance),d.popupInstance.data("triggerHovered",!0),t._showWhenVisible(u,n)):void 0},_getTourOverlay:function(t){var o;return o=e("#smallipop-tour-overlay"),o.length||(o=e('<div id="smallipop-tour-overlay"/>').appendTo(e("body")).fadeOut(0)),o.css({backgroundColor:t.tourHighlightColor,zIndex:t.tourHighlightZIndex})},_hideTourOverlay:function(t){return e("#smallipop-tour-overlay").fadeOut(t.tourHightlightFadeDuration),this._resetTourZIndices()},_resetTourZIndices:function(){var e,o,i,n,r,a;r=t.tours,a=[];for(i in r)o=r[i],a.push(function(){var t,i,r;for(r=[],t=0,i=o.length;i>t;t++)e=o[t],n=e.trigger,n.data("originalZIndex")?r.push(n.css("zIndex",n.data("originalZIndex"))):r.push(void 0);return r}());return a},_showWhenVisible:function(o,i){var n,r,a,s;return r=o.offset().top,n=r-e(document).scrollTop(),s=e(window).height(),a=o.data("smallipop").options,!this._isElementFixed(o)&&(a.autoscrollPadding>n||n>s-a.autoscrollPadding)?e("html, body").animate({scrollTop:r-s/2},800,"swing",function(){return t._showPopup(o,i)}):t._showPopup(o,i)},_tourNext:function(e){var o,i,n,r,a,s,l,p;if(null!=e&&e.preventDefault(),o=t.tours[t.currentTour])for(n=o[0].popupInstance,r=n.data("shown")||o[0].id,i=s=0,l=o.length-2;l>=0?l>=s:s>=l;i=l>=0?++s:--s)if(o[i].id===r)return null!=(p=o[i].trigger.data("smallipop"))&&"function"==typeof(a=p.options).onTourNext&&a.onTourNext(o[i+1].trigger),t._tourShow(t.currentTour,i+1)},_tourPrev:function(e){var o,i,n,r,a,s,l,p;if(null!=e&&e.preventDefault(),o=t.tours[t.currentTour])for(n=o[0].popupInstance,r=n.data("shown")||o[0].id,i=s=1,l=o.length-1;l>=1?l>=s:s>=l;i=l>=1?++s:--s)if(o[i].id===r)return null!=(p=o[i].trigger.data("smallipop"))&&"function"==typeof(a=p.options).onTourPrev&&a.onTourPrev(o[i-1].trigger),t._tourShow(t.currentTour,i-1)},_tourClose:function(o){var i;return null!=o&&o.preventDefault(),i=e(o.target).closest(".smallipop-instance"),t._hideSmallipop(i)},_destroy:function(t){return t.each(function(){var t,o;return o=e(this),t=o.data("smallipop"),t?o.unbind(".smallipop").data("smallipop",{}).removeClass("smallipop sipInitialized smallipop"+t.id+" "+t.options.theme):void 0})},_onWindowKeyUp:function(e){var o,i,n,r,a,s;switch(n="input"===(r=null!=e?e.target.tagName.toLowerCase():void 0)||"textarea"===r,e.which){case 27:a=t.instances,s=[];for(i in a)o=a[i],s.push(t._hideSmallipop(o));return s;case 37:if(!n)return t._tourPrev();break;case 39:if(!n)return t._tourNext()}},_getInstance:function(o,i){var n;return null==o&&(o="default"),null==i&&(i=!1),t.instances[o]?t.instances[o]:(n=e(t.templates.popup).css("opacity",0).attr("id","smallipop"+t.nextInstanceId++).addClass("smallipop-instance").data({xDistance:0,yDistance:0,isTour:i}).bind({"mouseover.smallipop":t._triggerMouseover,"mouseout.smallipop":t._triggerMouseout}),e("body").append(n),i?n.delegate(".smallipop-tour-prev","click.smallipop",t._tourPrev).delegate(".smallipop-tour-next","click.smallipop",t._tourNext).delegate(".smallipop-tour-close, .smallipop-tour-close-icon","click.smallipop",t._tourClose):n.delegate("a","click.smallipop",t._hideSmallipop),2===t.nextInstanceId&&(e(document).bind("click.smallipop touchend.smallipop",t._hideSmallipop),e(window).bind({"resize.smallipop":t._queueRefreshPosition,"scroll.smallipop":t._onWindowScroll,keyup:t._onWindowKeyUp})),t.instances[o]=n)}},e.easing.easeInOutQuad||(e.easing.easeInOutQuad=function(e,t,o,i,n){return 1>(t/=n/2)?i/2*t*t+o:-i/2*(--t*(t-2)-1)+o}),e.fn.smallipop=function(o,i){var n;if(null==o&&(o={}),null==i&&(i=""),"string"==typeof o){switch(o.toLowerCase()){case"show":t._showSmallipop.call(this.first().get(0));break;case"hide":t._hideSmallipop(this.first().get(0));break;case"destroy":t._destroy(this);break;case"tour":t._runTour(this.first(),i);break;case"update":t.setContent(this.first(),i)}return this}return o=e.extend({},t.defaults,o),("undefined"!=typeof Modernizr&&null!==Modernizr?Modernizr.cssanimations:void 0)===!1&&(o.cssAnimations.enabled=!1),n=t._getInstance(),this.each(function(){var r,a,s,l,p,u,d,c,h,f,g,m,v,T,_;if(d=e(this),c=d[0].tagName.toLowerCase(),T=d.attr("type"),f=d.data(),l=i||d.attr("title"),r=e("."+o.infoClass,d),r.length&&(l=r.clone(!0,!0).removeClass(""+o.infoClass)),l&&!d.hasClass("sipInitialized")){s=t.lastId++,g={},v=n,m=e.extend(!0,{},o),"object"==typeof f.smallipop&&e.extend(!0,m,f.smallipop);for(p in f)_=f[p],p.indexOf("smallipop")>=0&&(u=p.replace("smallipop",""),u&&(u=u.substr(0,1).toLowerCase()+u.substr(1),m[u]=_));if(a=m.handleInputs&&("input"===c||"select"===c||"textarea"===c),a?(m.hideOnTriggerClick=!1,g["focus.smallipop"]=t._triggerMouseover,g["blur.smallipop"]=t._triggerMouseout):g["mouseout.smallipop"]=t._triggerMouseout,m.triggerOnClick||m.touchSupport&&t._onTouchDevice()?g["click.smallipop"]=t._showSmallipop:(g["click.smallipop"]=t._triggerMouseout,g["mouseover.smallipop"]=t._triggerMouseover),m.tourIndex&&(h=m.tourTitle||"defaultTour",g={},m.hideOnTriggerClick=!1,m.hideOnPopupClick=!1,v=t._getInstance(h,!0),t.tours[h]||(t.tours[h]=[]),t.tours[h].push({index:m.tourIndex||0,id:s,trigger:d,popupInstance:v})),d.addClass("sipInitialized smallipop"+s).attr("title","").data("smallipop",{id:s,hint:l,options:m,tagName:c,type:T,tourTitle:h,popupInstance:v}).bind(g),!m.hideOnTriggerClick)return d.delegate("a","click.smallipop",t._hideSmallipop)}})}})(jQuery);